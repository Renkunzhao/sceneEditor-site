<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />

  <script src="https://threejs.org/build/three.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script type="text/javascript"
    src="http://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script type="text/javascript" src="https://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  <script type="text/javascript" src="lib/ros3d.js"></script>
  <script type="text/javascript" src="scripts/mouse.js"></script>
  <script type="text/javascript" src="scripts/region.js"></script>

  <script type="text/javascript" type="text/javascript">
    /**
     * Setup all visualization elements when the page is loaded.
     */
    var viewer, canvas;
    var markerClient, selected;
    var mouseHandler, regionEditor;
    var raycaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();
    function init() {

      // Connect to ROS.
      var ros = new ROSLIB.Ros({
        url: 'ws://192.168.1.199:9090'
      });

      // Create the main viewer.
      viewer = new ROS3D.Viewer({
        divID: 'markers',
        width: 400,
        height: 300,
        antialias: true,
        cameraPose: {
          x: 0,
          y: 0,
          z: 50
        }
      });
      // viewer.addObject(new ROS3D.Grid(), true);
      canvas = viewer.renderer.domElement;
      canvas.addEventListener('click', PosCatch, false);

      // Setup a client to listen to TFs.
      var tfClient = new ROSLIB.TFClient({
        ros: ros,
        angularThres: 0.01,
        transThres: 0.01,
        rate: 10.0,
        fixedFrame: '/my_frame'
      });

      // Setup the marker client.
      markerClient = new ROS3D.MarkerClient({
        ros: ros,
        tfClient: tfClient,
        topic: '/visualization_marker',
        rootObject: viewer.scene
      });

      mouseHandler = new MouseHandler();
      regionEditor = new RegionEditor();
      $("#interact").click(function(){
            mouseHandler.mousemod = MOUSEMOD.Interact;
      })
      $("#regionSet").click(function(){
            mouseHandler.mousemod = MOUSEMOD.RegionSet;
      })
    }
    function OrbitReset() {

    }
    function PosCatch(event) {
      var rect = canvas.getBoundingClientRect();
      var x = event.clientX - rect.left * (canvas.width / rect.width);
      var y = event.clientY - rect.top * (canvas.height / rect.height);
      // 将鼠标位置归一化为设备坐标。x 和 y 方向的取值范围是 (-1 to +1)
      mouse.x = (x / canvas.width) * 2 - 1;
      mouse.y = - (y / canvas.height) * 2 + 1;
      console.log(mouse.x, mouse.y);
      // 通过摄像机和鼠标位置更新射线
      raycaster.setFromCamera(mouse, viewer.camera);
      // 计算物体和射线的焦点
      var intersects = raycaster.intersectObjects(viewer.scene.children);
      console.log(intersects.length);
      for (var i = 0; i < intersects.length; i++) {
        intersects[i].object.material.color.set(0xff0000);
        console.log(intersects[i]);
        selected = intersects[i].object;
      }
    }
    // 平面模型
    function PlaneZ() {
      var geometry = new THREE.PlaneGeometry(20, 20);
      var material = new THREE.MeshBasicMaterial({ color: 0xffff00, side: THREE.DoubleSide });
      var plane = new THREE.Mesh(geometry, material);
      viewer.addObject(plane);
    }
    function move() {
      for (marker in markerClient.markers) {
        selected.translateX(2);
      }
    }
    function MarkerList() {
      console.log(markerClient.markers)
    }
  </script>
</head>

<body onload="init()">
  <h1>Simple Marker Example</h1>
  <div id="markers" style="text-align: center;"></div>
  <input type="button" value="Interact" id="interact">
  <button onclick="OrbitReset()">重置视角</button>
  <button onclick="PlaneZ()">生成z=0平面</button>
  <button onclick="MarkerList()">test</button>
  <button onclick="move()">移动</button>
  <form class="RegionEditor">
    RegionEditor<br>
    p1: <input type="text" id="p1"><br>
    p2: <input type="text" id="p2"><br>
    p3: <input type="text" id="p3"><br>
    p4: <input type="text" id="p4"><br>
    <input type="button" value="Set reach region" id="regionSet">
  </form>
</body>

</html>